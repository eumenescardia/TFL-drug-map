<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>London Underground Map (Embedded)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #header { font-family: 'Goudy Old Style', serif; font-size: 26px; font-weight: bold; background: white; padding: 10px; text-align: left; }
    #subheader { font-family: 'Goudy Old Style', serif; font-size: 14px; font-weight: normal; background: white; padding: 0 10px 10px; text-align: left; }
    #map { height: calc(100% - 80px); }
    #attribution { font-family: 'Goudy Old Style', serif; font-size: 10px; background: white; text-align: center; padding: 4px 0; }
    .leaflet-tooltip { background: white; border: 1px solid #ccc; padding: 4px 6px; font-size: 12px; }
    .leaflet-tooltip strong { display: block; margin-bottom: 2px; }
    .leaflet-control-scale, .leaflet-control-northarrow { margin-bottom: 10px; }
    .leaflet-control-northarrow { background: rgba(255,255,255,0.8); padding: 4px 6px; font-size: 14px; font-weight: bold; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="header"Drugs on the Underground</div>
  <div id="subheader">Drugs confiscated or recorded as lost property on the London Underground since 2020</div>
  <div id="map"></div>
  <div id="attribution">Map: The Spectator • Source: FOI for TFL</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Line colors
    const lineColors = {
      bakerloo: "#B36305", central: "#E32017", circle: "#FFD300", district: "#00782A",
      hammersmith_and_city: "#F3A9BB", jubilee: "#A0A5A9", metropolitan: "#9B0056",
      northern: "#000000", piccadilly: "#003688", victoria: "#0098D4", waterloo_and_city: "#95CDBA"
    };
    const priorityOrder = ['northern','victoria','central','bakerloo','metropolitan'];

    function normalize(name) {
      return name.toLowerCase().replace(/ & /g,' and ').replace(/[\s/]+/g,'_').replace(/_+/g,'_');
    }

    // Map setup
    const initialCenter = [51.5074, -0.1278];
    const initialZoom = 11;
    const latFactor = 1/111000;
    const lonFactor = 1/(111000 * Math.cos(initialCenter[0] * Math.PI/180));
    const buf = 2000;
    const latBuf = buf * latFactor;
    const lonBuf = buf * lonFactor;
    const sw0 = [51.28, -0.53];
    const ne0 = [51.70, 0.30];
    const bounds = L.latLngBounds([
      [sw0[0] - latBuf, sw0[1] - lonBuf],
      [ne0[0] + latBuf, ne0[1] + lonBuf]
    ]);

    const map = L.map('map', {
      maxBounds: bounds,
      maxBoundsViscosity: 1.0,
      minZoom: initialZoom
    }).setView(initialCenter, initialZoom);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB' }).addTo(map);
    L.control.scale({ position: 'bottomright', imperial: true, metric: false }).addTo(map);
    var north = L.control({ position: 'bottomright' });
    north.onAdd = function(map) {
      var d = L.DomUtil.create('div', 'leaflet-control-northarrow');
      d.innerHTML = 'N ↑';
      return d;
    };
    north.addTo(map);

    // Data fetch promises
    const linesUrl = 'https://raw.githubusercontent.com/eumenescardia/TFL-drug-map/main/data-lines.json';
    const stationsUrl = 'https://raw.githubusercontent.com/eumenescardia/TFL-drug-map/main/data-stations.json';
    const itemsUrl = 'https://raw.githubusercontent.com/eumenescardia/TFL-drug-map/main/data-items.json';

    const linesPromise = fetch(linesUrl).then(r => { if (!r.ok) throw new Error('Lines missing'); return r.json(); });
    const stationsPromise = fetch(stationsUrl).then(r => { if (!r.ok) throw new Error('Stations missing'); return r.json(); });
    const itemsPromise = fetch(itemsUrl).then(r => r.ok ? r.json() : []).catch(() => []);

    Promise.all([linesPromise, stationsPromise, itemsPromise])
      .then(([lines, stations, items]) => {
        const itemsMap = {};
        items.forEach(row => {
          if (!itemsMap[row.Station]) itemsMap[row.Station] = [];
          itemsMap[row.Station].push({ item: row.Item, count: row.Count });
        });

        const removeList = ['West Drayton','Twickenham','Gospel Oak','Stamford Hill','Forest Gate'];
        stations.features = stations.features.filter(f => !removeList.includes(f.properties.name));

        lines.features.forEach(f => {
          L.geoJSON(f, {
            style: { color: lineColors[normalize(f.properties.name)] || '#000', weight: 4 },
            interactive: false
          }).addTo(map);
        });

        L.geoJSON(stations, {
          pointToLayer: (feat, latlng) => {
            const props = feat.properties;
            let arr = props.lines || props.line || [];
            arr = Array.isArray(arr) ? arr : [arr];
            const pick = priorityOrder.find(p => arr.map(normalize).includes(p)) || normalize(arr[0] || '');
            const col = lineColors[pick] || '#000';

            let html = `<strong>${props.name}</strong>`;
            (itemsMap[props.name] || []).forEach(it => { html += `<br>${it.count}x ${it.item}`; });

            return L.circleMarker(latlng, { radius: 5, fillColor: col, color: col, weight: 0.5, opacity: 1, fillOpacity: 1 })
              .bindTooltip(html, { permanent: false, direction: 'top' });
          }
        }).addTo(map);
      })
      .catch(e => { console.error(e); alert('Map failed: ' + e); });
  </script>
</body>
</html>
